#include <iostream>
#include <sstream>
#include <algorithm>
#include <iomanip>
#include <cstdint>

#include "defs.h"

void decrypt_main(const uint8 key_basis[16], uint8 dst[16]);
void bind_key(const uint8 decrypted_key[16], const uint8 file_id[20], uint8 dst[16]);
uint32 process(char a1, uint32 a2, uint32 a3, uint32 a4, uint32 a5);

template <typename A>
unsigned char _bittest(A *a, int b)
{
    auto const bits{reinterpret_cast<unsigned char const *>(a)};
    auto const value{bits[b >> 3]};
    auto const mask{(unsigned char)(1 << (b & 7))};
    return (value & mask) != 0;
}

/* pick 32-bit unsigned integer in little endian order */
static unsigned int U8TOU32(const unsigned char *p) {
	return (((unsigned int)(p[0] & 0xff)) | ((unsigned int)(p[1] & 0xff) << 8) |
					((unsigned int)(p[2] & 0xff) << 16) | ((unsigned int)(p[3] & 0xff) << 24));
}

static int char2int(char input)
{
    if (input >= '0' && input <= '9')
        return input - '0';
    if (input >= 'A' && input <= 'F')
        return input - 'A' + 10;
    if (input >= 'a' && input <= 'f')
        return input - 'a' + 10;
    throw std::invalid_argument("Invalid input string");
}

static void hex2bin(const char *src, char *target)
{
    while (*src && src[1])
    {
        *(target++) = char2int(*src) * 16 + char2int(src[1]);
        src += 2;
    }
}

// 
// purriau
// bound data to 0132b6f3165865ff69a47d4321ff7520
static const uint32 playIntentKey[0x300] = {
    0xA5A9847F, 0xB76476AD, 0x38F9994B, 0xC1C8FB7A, 0x3B87410F, 0x36EBCB78,
    0x66D40275, 0xA70E528D, 0xC0A021C5, 0x3A5E6759, 0x73EE44B7, 0xF5836754,
    0x567DDE55, 0xAD0E9632, 0xA873209C, 0x003042C7, 0x63982097, 0x93805793,
    0xF6E83562, 0xED4C76E3, 0xAE736441, 0xEFDA1EA7, 0x6998643C, 0x64FCEEA5,
    0x94E525A1, 0xF84D0371, 0x0507ACB6, 0x686F8A86, 0xC02CACB1, 0x6AFD324A,
    0x848F0181, 0xBE1EDEDF, 0xF4B18896, 0x2E4165F4, 0x91A943C3, 0xC1917AC0,
    0x24F9588F, 0x54E18F8B, 0x27870053, 0xF61656A5, 0x2FA63402, 0xB13B56A0,
    0xC2F648CE, 0x3CB48E63, 0x7E1B48C9, 0x9680ADB3, 0x35A677A7, 0x990E5577,
    0xB2A024AE, 0xEC30020C, 0x6DC524A9, 0x5C528921, 0xD610CEB5, 0xEFA29DEC,
    0x530A7BBC, 0xCA5B5A82, 0xED94D01A, 0x85805A7C, 0x5DB7572F, 0xDF4C79CC,
    0xF1076BFB, 0x729C8E98, 0xAC2C6BF6, 0x25EAB18A, 0x86E5288B, 0x5F1C253E,
    0xF707AFA0, 0xF26C3A0A, 0x74015CA7, 0xAD913A04, 0x0BF8CEEB, 0x1DB3C119,
    0x2F6EB348, 0xF86C7DAE, 0x1BA5F347, 0xB3917DA9, 0xAEF60813, 0x23B404BE,
    0x1F188F28, 0xA0ADB1C5, 0xDA3D8F23, 0x3B380623, 0xB4F64BB8, 0xA383B030,
    0x2518D2CD, 0x207D5D36, 0xB868E798, 0xDBA25D31, 0x738DE793, 0x4BC4E446,
    0xACBF5B47, 0x267DA0DB, 0x600D7E39, 0xE1A2A0D6, 0xF35D9305, 0x74F2B5A2,
    0x4D29B255, 0x7D11E951, 0xE079C720, 0x69492950, 0xE3076EE5, 0xFC993E1C,
    0x5329F5F9, 0x64E4E828, 0xE67A0AC5, 0x09B3805E, 0x399BB75A, 0x9D03952A,
    0x3C295F1E, 0x548EC408, 0x95F57E6E, 0x0FB3C403, 0x216EB631, 0xA303D8CF,
    0xB4BECAFD, 0xAB230C7E, 0x55F39216, 0xADB0B442, 0x11189211, 0x2AAA6149,
    0xA468A6DD, 0x92F60B55, 0xD45CC5BB, 0x4E1B0B50, 0x67ACDA87, 0x127D6020,
    0x6A3A824B, 0xCDA2601B, 0xDA5D0960, 0x3DC4E730, 0x5756B667, 0x6911A895,
    0xE2CFEE2A, 0x2436A890, 0xCF072E29, 0xDBC1D76F, 0x3F29B53E, 0x6F11EC3A,
    0xD279CA0A, 0x2A36EC35, 0x026DE8E8, 0x7C2C2E7C, 0x95BDFDB4, 0x5EBBC81A,
    0x7076BA49, 0xD3DE9818, 0x2B9BBA44, 0x03D2B6F6, 0x9BBE4159, 0x9722CBC2,
    0x10E11157, 0x99B07386, 0x1B459624, 0x2D008852, 0x6D3AD86B, 0x9D230F67,
    0x988799D1, 0x58480F62, 0x53AC99CC, 0xC86A9677, 0x0B37C8AA, 0x8CCCEB47,
    0x9E87DD76, 0xD817BAD3, 0x59ACDD70, 0x6B67CF9F, 0xC9CF6485, 0xC533EEEF,
    0x5D1F7951, 0xC7C196B3, 0x4956B950, 0x5B11AB7F, 0x499F0FF7, 0xCB343294,
    0xDCEF24C2, 0x5E844760, 0x981424BD, 0x19A9475A, 0x5C76798D, 0xBADE0E74,
    0xCC9900A2, 0x0628DE00, 0x87BE009D, 0x9978F2CC, 0x1B0E1569, 0x099B79E1,
    0xD2994447, 0xF5D2B9E0, 0x25BAF0DC, 0x8922CEAC, 0x9ADDC0DA, 0xF94555C1,
    0x0B0047EF, 0x8C956A8C, 0xC62547EA, 0x8F231251, 0x8A879CBA, 0xE244BEE6,
    0xFAAA23CF, 0x526745FA, 0xB5CF23CA, 0xC78A15F9, 0x491F3896, 0x5ADA2AC4,
    0x4BACE05A, 0x23E3DD0D, 0x53CC1409, 0xB733F1D8, 0xE71C28D5, 0x4A8406A4,
    0x39116B1C, 0xBAA68DB9, 0xF4366B17, 0x5530E217, 0xCEEF27AC, 0x1055E212,
    0x73BDBFE2, 0x80786927, 0xE3E046F7, 0xF59B3925, 0x77305BC2, 0xD82AD2C3,
    0x11BAB021, 0x8B78F5B5, 0x81DD3736, 0xE5451505, 0x152D4C01, 0x789529D1,
    0xD0524BFC, 0xE8B7B0E6, 0x71871316, 0x83420544, 0x04D727E1, 0x16921A10,
    0xB8254AD4, 0xD1B71A0B, 0x11F16A23, 0x41D9A120, 0x3D3E2B89, 0x1C925DB5,
    0x3FCBD34E, 0xC160F5EB, 0xD31BE819, 0x29AC9FF7, 0x433E6F2E, 0xBCFCB4C3,
    0xFE636F29, 0x4130A15C, 0xD91C2BBE, 0xB1532871, 0x32E84B0E, 0x44A33D3D,
    0xBE6182D1, 0xFFC83D38, 0x798682CC, 0x6FEAC44C, 0xB2B7F680, 0x4AA380E2,
    0x6DDCF67A, 0x05C880DC, 0x012D0B46, 0x5F94A02C, 0x714F925B, 0x830A848A,
    0x049FA727, 0x85982C4E, 0x072D4EEB, 0x0291D955, 0x774FD600, 0x72B4606A,
    0x0A9FEACC, 0x2DD96064, 0x3F945293, 0xC1297530, 0x4221FA57, 0x78B4A40E,
    0xB244816C, 0x33D9A409, 0x2F3E2E73, 0x40F920A2, 0x9F60B588, 0xB11BA7B6,
    0xA1EE5D4C, 0xB3A94F7B, 0x353E7218, 0x46F96446, 0xC88E86E4, 0xA0C58396,
    0xDA5560F4, 0x5BEA8391, 0x6DA575C0, 0x36A34026, 0x70331D84, 0xF1C84021,
    0xE055A499, 0x61EAC736, 0x73A5B965, 0x8D37889C, 0xF09F666B, 0xDF2CCAE3,
    0xA82A954A, 0xE9914FB0, 0x634F9545, 0x750A8773, 0xB67141DA, 0x302F876E,
    0x2693C8EE, 0xA0520E83, 0x9BB698ED, 0x64B46353, 0x949C9A4F, 0x1FD9634E,
    0x3194557D, 0x27F896FD, 0xA1B6DC91, 0xBB48ABC9, 0x3506F15D, 0xBDD6538D,
    0x213E315C, 0x2DF8DAA2, 0x9160B871, 0xA31BAAA0, 0xE4826506, 0x5E40AA9B,
    0x77D279D2, 0xCE6331B0, 0x2F5DA8B0, 0x92C58680, 0xC2ADBD7C, 0xE5E73315,
    0x7DD2BD77, 0x793747E1, 0xCFC7FFBE, 0xE959CEF5, 0x6318148A, 0xEBE776BA,
    0x4F4F5489, 0x7F378B85, 0x576E8838, 0xEF5A129A, 0xEABE9D04, 0x647CE299,
    0xA5E39CFF, 0x1FA1E293, 0x809C5994, 0xD72D1172, 0xF0BEE0A9, 0x2A4EBE07,
    0xABE3E0A4, 0xA7486B0D, 0x2106B0A2, 0x176AF222, 0xE068BC89, 0x19F899E6,
    0x2BB38C15, 0xAD48AEB2, 0xBF03A0E1, 0x1D6B35C7, 0x2F2627F6, 0xB0BB4A93,
    0xD3F4C02C, 0x9CF28A92, 0xAEAD7CC1, 0xE83D5A1E, 0x1ED003D6, 0x585FE133,
    0xD9F503D0, 0xEBAFF5FF, 0x6D45189C, 0x457C154F, 0xE4A1DF44, 0x4809BD13,
    0x59C4AF42, 0xDB59D1DF, 0xED14C40E, 0x6EA9E6AB, 0x5D374B22, 0xDECC6DC0,
    0x185C4B1D, 0x7956C21E, 0xDCBE9FEE, 0x164E7D4B, 0x97E39FE8, 0x86710460,
    0x080626FD, 0x19C1192C, 0x9B563BC9, 0xF479D5C1, 0x35E09027, 0x4E45F511,
    0x87D5D26F, 0x096AF50C, 0x1B25E73A, 0x9CBB09D8, 0xD64AE735, 0xCCAF28B6,
    0x8DD61614, 0xA767E54B, 0x0ACFC31A, 0x628CE546, 0xC5F4C315, 0xD7AFB544,
    0x36174A2A, 0x47D23C59, 0x61640B90, 0x228AF8EE, 0x63F1B354, 0xDDAFF8E9,
    0xD4143A69, 0x377C1839, 0x49370A67, 0xCACC2D04, 0x045C0A62, 0x65568163,
    0xDF14C6F7, 0xD5790877, 0x4F374E0C, 0x68C91D43, 0xCC30FB13, 0x05C0D871,
    0x35A90F6D, 0x75E35F85, 0xD6DDD686, 0x509C1C1B, 0x9202D681, 0x0BC11C15,
    0x2552EB4D, 0x7BE3A32A, 0x95757261, 0xA7306490, 0x326D2D8F, 0x9367A48F,
    0x0D25EA24, 0x26B7B95B, 0x7D487139, 0x96DA4070, 0x10988605, 0x51FF406B,
    0x63BA329A, 0xC7221069, 0x04EEF9B3, 0x9CDA8415, 0xC013F9AE, 0x39D23F42,
    0x53640E79, 0x651F00A8, 0xC386958E, 0xD54187BD, 0xC6143D53, 0xC178C7BC,
    0x5964521E, 0x54C8DC88, 0xCE87221C, 0xC4EB639D, 0xFE7B40FB, 0x80106398,
    0x91CB55C6, 0x5AC9202D, 0x9458FD8B, 0xCAEBA742, 0xEE251CDA, 0xFFE00F09,
    0x817531A6, 0x933023D5, 0x14C54672, 0x0352AAEA, 0xCC507550, 0x05E052AE,
    0x8775754B, 0x9930677A, 0xBC69DD12, 0x3DFEFFB0, 0x2C8C6427, 0xAE2186C4,
    0xBFDC78F3, 0x88DA435A, 0xC26A20B7, 0x43FF4354, 0x328CA7CC, 0x2DF13236,
    0xAF8654D3, 0xC1414702, 0x42D6699F, 0xC3CEEEC6, 0x45641163, 0x33F175DB,
    0x4D834512, 0xC7418AA6, 0xEA7B003F, 0x82668AA1, 0x7DCB150B, 0xDC32A9F1,
    0x355643E9, 0xB6EB6686, 0xC8A658B5, 0x0A0D131B, 0x83CB58B0, 0x7A2F9A30,
    0xF3EDDFC5, 0xEF526A2E, 0x873DF490, 0xF1E011F3, 0x73753490, 0x853026BE,
    0x7B94683F, 0xF552ADD3, 0x0EE47D0A, 0xB077ADCE, 0xABDC3838, 0x43C7C29A,
    0x8194ABE4, 0x7CF9364D, 0xF6B77BE2, 0x381E3648, 0xB1DC7BDD, 0xCB6E4B14,
    0x21FF02F1, 0x1D638D5B, 0xE66157C2, 0x3E1E79ED, 0x4FD96C1C, 0xB34149EB,
    0xCCD31922, 0x2363D100, 0x3CF5A037, 0xB6B3E5CC, 0xF81AA032, 0xB9418D90,
    0xD2D35CC7, 0xC160C13F, 0x42F5E3DC, 0x662F5975, 0xDFED9F09, 0xF97F6E41,
    0x733DB3D5, 0x69A1F555, 0xEA9A7A7D, 0x6C2F9D1A, 0x7DEA8F48, 0xFF7FB1E5,
    0x113AA414, 0x74A281E4, 0x6B06C364, 0xE4C508F9, 0x262BC35F, 0x7F4F5D57,
    0x00E47FF4, 0x3A745D52, 0x71070709, 0xAA96E467, 0x0DFEC236, 0x3DE6F932,
    0x394B839C, 0x2A1E3932, 0x3BD92B60, 0x9A40C046, 0xABFBB275, 0x2D90D512,
    0x3F4BC741, 0xC0E0E9DE, 0xFA70C73C, 0xD2A7C3EF, 0x9BA58E55, 0xAD608084,
    0x2EF5A321, 0x6885807F, 0xEA1AA31C, 0xD8A80793, 0x5A3D2A30, 0x6BF81C5F,
    0x675CA6C9, 0x305A712F, 0x69EA4E8D, 0xEB7F712A, 0xDA0CD5A2, 0x5BA1F83F,
    0x6D5CEA6E, 0xA6ECC7CB, 0x2881EA69, 0x897C6169, 0x033AA6FE, 0xDB71A3B0,
    0x5D06C64E, 0x6EC1B87C, 0x182BC648, 0x29E6B877, 0x18741CEF, 0x9A093F8C,
    0xFB03B68D, 0x74C1FC21, 0x97FB71BA, 0x19909457, 0x2B4B8686, 0x89B31B6C,
    0x9B6E0D9A, 0xDCD4C801, 0x56930D95, 0xB78D8496, 0x314BCA2A, 0x27B00BAB,
    0x8B17E97A, 0x9CD2DBA9, 0xF48FFDD4, 0x57F7DBA4, 0x7189AADB, 0xC81A62B9,
    0x2914D9B9, 0xA2D31F4E, 0xE439D9B4, 0x5DF81F49, 0x595CA9B2, 0x8944E0AF,
    0xC97F30C7, 0xE310FFFE, 0xCC0CD88B, 0xE59EA7C3, 0x5F5CED57, 0x78EEBC8E,
    0xCF7F746C, 0xCAE3FED6, 0x22A12101, 0x8608FED1, 0xB5F135CD, 0x60C1BB66,
    0xA22875CC, 0xD0E4427B, 0x124AFCE1, 0x2405EF10, 0xA59B11AD, 0xB75603DB,
    0x1ABDE1AB, 0x27788AF0, 0xFA1DFBB8, 0x13AFCAEF, 0x8D6E1084, 0xA6FFDFBB,
    0xE08FBD19, 0x172266D0, 0x50B2442E, 0xB41A21FD, 0xE40258FA, 0xAD002360,
    0xD03998F9, 0x49F7DE8D, 0x405C200E, 0x5217123C, 0xD3AC34D9, 0xE5672708,
    0x48CF04D8, 0xE7F4CECC, 0x6989F169, 0x41C0EE1C, 0x537BE04B, 0xD51102E8,
    0x0EA0E046, 0x903602E3, 0x7EC3675B, 0x005889F8, 0x597C23F0, 0xDB11468D,
    0xECCC38BB, 0x1005AE54, 0xA7F138B6, 0x80283569, 0x01BD5806, 0x13784A35,
    0x950D6CD2, 0x1605F1F9, 0x2F97C130, 0xA95606C5, 0x818D0378, 0x19788DDA,
    0x3CB20372, 0xBE472610, 0xD002183E, 0x2E69AD24, 0x878D471C, 0xA11F1654,
    0x1ADD5BE8, 0x3E16D181, 0xD6025BE3, 0xD166E64D, 0x2FCE7B33, 0x41896D62,
    0x0A8737C8, 0x44171526, 0x5DA8E45D, 0xD76729F2, 0xAF9E26A4, 0x4789B106,
    0x42EE3B70, 0x02AEB101, 0xFE133B6B, 0x5F0DB26C, 0xD8CBF800, 0xCF303980,
    0x48EE7F15, 0x8A55397B, 0x04137F10, 0x15CE713F, 0x976393DC, 0x6F9A908E,
    0xF869F2BE, 0x72283853, 0x8BBA078A, 0x05784D1E, 0x1F0A1C56, 0x759AD433,
    0x8755C662, 0x08EAE8FF, 0x2C245E98, 0xA3753D5D, 0x06DD1B2D, 0x5E9A3D58,
    0x76FFA242, 0xB8665CA8, 0x3224A23D, 0x43DF946B, 0x5D7163A3, 0x4E441938,
    0x5FFF0B67, 0xA0395B7F, 0xD021927C, 0x3389704B, 0x4D1B3F82, 0xC6D98517,
    0xBD3DC697, 0xF6CDA3F5, 0xBFCB6E5B, 0xD186608A, 0x34EE3E5A, 0x8CAB6085,
    0xF0133E55, 0xE6777FD5, 0x6035C569, 0x79C794A1, 0x8B8286CF, 0x54805136,
    0x8E102E94, 0x0FA55131, 0xFE32B5A8, 0x619A9378, 0x9182CA74, 0xB4BC400D,
    0x4CA7CA6F, 0x24DEC722, 0xEDDC9188, 0xFF9783B7, 0x812CA654, 0xBABC83B2,
    0x1E246181, 0x4E0C987E, 0x26439530, 0xBE2F1F92, 0x00FC51C5, 0x82917463,
    0xBC2151C0, 0x3DB6745D, 0x4F71668C, 0x3DFECB04, 0xBF93EDA1, 0xE2CD633A,
    0x7AB8ED9C, 0xBD861FCF, 0x3F1B426C, 0x2DA8A6E4, 0xAF3DC981, 0xC0F8BBAF
};